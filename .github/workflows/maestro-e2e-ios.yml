name: Maestro E2E Tests (iOS)

on:
  schedule:
    - cron: "0 0 * * 0" # At 00:00 on Sunday
  pull_request:
    types: [labeled]

jobs:
  e2e-test-ios:
    name: Run E2E Tests on iOS
    # Only run if the 'run-e2e-tests' label is added or if it's a scheduled run
    if: |
      github.event_name == 'schedule' || 
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-e2e-tests'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH":"$HOME/.maestro/bin"

      - name: Run E2E tests on EAS
        run: |
          eas build --platform ios --profile preview --non-interactive --wait --auto-submit
          LATEST_BUILD_ID=$(eas build:list --platform ios --status finished --non-interactive --json | jq -r '.[0].id')
          eas build:run-tests --build-id $LATEST_BUILD_ID --platform ios
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
